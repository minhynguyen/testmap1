function polygonStyleFunction(e,t){return new ol.style.Style({stroke:new ol.style.Stroke({color:"blue",width:1}),fill:new ol.style.Fill({color:"rgba(0, 0, 255, 0.1)"}),text:createTextStyle(e,t,myDom.polygons)})}function lineStyleFunction(e,t){return new ol.style.Style({stroke:new ol.style.Stroke({color:"green",width:5}),text:createTextStyle(e,t,myDom.lines)})}function pointStyleFunction(e,t){return new ol.style.Style({image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:3})}),text:createTextStyle(e,t,myDom.points)})}function bindInputs(e,t){var o=$(e+" input.visible");o.on("change",function(){t.setVisible(this.checked)}),o.prop("checked",t.getVisible());var n=$(e+" input.opacity");n.on("input change",function(){t.setOpacity(parseFloat(this.value))}),n.val(String(t.getOpacity()))}function stringDivider(e,t,o){if(e.length>t){for(var n=t;n>0&&" "!=e[n]&&"-"!=e[n];)n--;if(n>0){var l;l="-"==e.substring(n,n+1)?e.substring(0,n+1):e.substring(0,n);var i=e.substring(n+1);return l+o+stringDivider(i,t,o)}}return e}function addInteraction(){var e="area"==typeSelect.value?"Polygon":"LineString";draw=new ol.interaction.Draw({source:source,type:e,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.5)",lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})})}),map.addInteraction(draw),createMeasureTooltip(),createHelpTooltip();var t;draw.on("drawstart",function(e){sketch=e.feature;var o=e.coordinate;t=sketch.getGeometry().on("change",function(e){var t,n=e.target;n instanceof ol.geom.Polygon?(t=formatArea(n),o=n.getInteriorPoint().getCoordinates()):n instanceof ol.geom.LineString&&(t=formatLength(n),o=n.getLastCoordinate()),measureTooltipElement.innerHTML=t,measureTooltip.setPosition(o)})},this),draw.on("drawend",function(){measureTooltipElement.className="tooltip tooltip-static",measureTooltip.setOffset([0,-7]),sketch=null,measureTooltipElement=null,createMeasureTooltip(),ol.Observable.unByKey(t)},this)}function createHelpTooltip(){helpTooltipElement&&helpTooltipElement.parentNode.removeChild(helpTooltipElement),helpTooltipElement=document.createElement("div"),helpTooltipElement.className="tooltip hidden",helpTooltip=new ol.Overlay({element:helpTooltipElement,offset:[15,0],positioning:"center-left"}),map.addOverlay(helpTooltip)}function createMeasureTooltip(){measureTooltipElement&&measureTooltipElement.parentNode.removeChild(measureTooltipElement),measureTooltipElement=document.createElement("div"),measureTooltipElement.className="tooltip tooltip-measure",measureTooltip=new ol.Overlay({element:measureTooltipElement,offset:[0,-15],positioning:"bottom-center"}),map.addOverlay(measureTooltip)}var wgs84Sphere=new ol.Sphere(6378137),raster=new ol.layer.Tile({source:new ol.source.OSM}),source=new ol.source.Vector,vector=new ol.layer.Vector({source:source,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),myDom={points:{text:document.getElementById("points-text"),align:document.getElementById("points-align"),baseline:document.getElementById("points-baseline"),rotation:document.getElementById("points-rotation"),font:document.getElementById("points-font"),weight:document.getElementById("points-weight"),size:document.getElementById("points-size"),offsetX:document.getElementById("points-offset-x"),offsetY:document.getElementById("points-offset-y"),color:document.getElementById("points-color"),outline:document.getElementById("points-outline"),outlineWidth:document.getElementById("points-outline-width"),maxreso:document.getElementById("points-maxreso")},lines:{text:document.getElementById("lines-text"),align:document.getElementById("lines-align"),baseline:document.getElementById("lines-baseline"),rotation:document.getElementById("lines-rotation"),font:document.getElementById("lines-font"),weight:document.getElementById("lines-weight"),size:document.getElementById("lines-size"),offsetX:document.getElementById("lines-offset-x"),offsetY:document.getElementById("lines-offset-y"),color:document.getElementById("lines-color"),outline:document.getElementById("lines-outline"),outlineWidth:document.getElementById("lines-outline-width"),maxreso:document.getElementById("lines-maxreso")},polygons:{text:document.getElementById("polygons-text"),align:document.getElementById("polygons-align"),baseline:document.getElementById("polygons-baseline"),rotation:document.getElementById("polygons-rotation"),font:document.getElementById("polygons-font"),weight:document.getElementById("polygons-weight"),size:document.getElementById("polygons-size"),offsetX:document.getElementById("polygons-offset-x"),offsetY:document.getElementById("polygons-offset-y"),color:document.getElementById("polygons-color"),outline:document.getElementById("polygons-outline"),outlineWidth:document.getElementById("polygons-outline-width"),maxreso:document.getElementById("polygons-maxreso")}},getText=function(e,t,o){var n=o.text.value,l=o.maxreso.value,i=e.get("name");return t>l?i="":"hide"==n?i="":"shorten"==n?i=i.trunc(12):"wrap"==n&&(i=stringDivider(i,16,"\n")),i},createTextStyle=function(e,t,o){var n=o.align.value,l=o.baseline.value,i=o.size.value,r=parseInt(o.offsetX.value,10),s=parseInt(o.offsetY.value,10),a=o.weight.value,c=parseFloat(o.rotation.value),u=a+" "+i+" "+o.font.value,m=o.color.value,d=o.outline.value,g=parseInt(o.outlineWidth.value,10);return new ol.style.Text({textAlign:n,textBaseline:l,font:u,text:getText(e,t,o),fill:new ol.style.Fill({color:m}),stroke:new ol.style.Stroke({color:d,width:g}),offsetX:r,offsetY:s,rotation:c})},vectorPolygons=new ol.layer.Vector({source:new ol.source.Vector({url:"data/geojson/polygon-samples.geojson",format:new ol.format.GeoJSON}),style:polygonStyleFunction}),vectorLines=new ol.layer.Vector({source:new ol.source.Vector({url:"data/geojson/line-samples.geojson",format:new ol.format.GeoJSON}),style:lineStyleFunction}),vectorPoints=new ol.layer.Vector({source:new ol.source.Vector({url:"data/geojson/point-samples.geojson",format:new ol.format.GeoJSON}),style:pointStyleFunction}),mousePositionControl=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(10),projection:"EPSG:4326",className:"custom-mouse-position",target:document.getElementById("mouse-position"),undefinedHTML:"&nbsp;"}),projectionSelect=document.getElementById("projection");projectionSelect.addEventListener("change",function(e){mousePositionControl.setProjection(e.target.value)});var precisionInput=document.getElementById("precision");precisionInput.addEventListener("change",function(e){var t=ol.coordinate.createStringXY(e.target.valueAsNumber);mousePositionControl.setCoordinateFormat(t)});var osm=new ol.layer.Tile({source:new ol.source.OSM}),bing=new ol.layer.Tile({source:new ol.source.BingMaps({imagerySet:"Road",key:" gqVNfloISCI4p3jzmA3S~f9uI402l5ZCG-_d7iagAcg~AquLQ_2qUIHZSGa00DVwnREHcD6ZRYGcUdJBdvbaF0VMQZWh-3tLD-lvzVDfac0y"})}),sketch,helpTooltipElement,helpTooltip,measureTooltipElement,measureTooltip,continuePolygonMsg="Nhấp chuột vào điểm tiếp theo để tiếp tục đo/Nhấp đúp chuột để dừng lại",continueLineMsg="Nhấp chuột vào điểm tiếp theo để tiếp tục đo/Nhấp đúp chuột để dừng lại",pointerMoveHandler=function(e){if(!e.dragging){var t="Nhấp chuột để bắt đầu vẽ đường do đạc";if(sketch){var o=sketch.getGeometry();o instanceof ol.geom.Polygon?t=continuePolygonMsg:o instanceof ol.geom.LineString&&(t=continueLineMsg)}helpTooltipElement.innerHTML=t,helpTooltip.setPosition(e.coordinate),helpTooltipElement.classList.remove("hidden")}},map=new ol.Map({layers:[raster,vector,new ol.layer.Group({layers:[vectorPoints,vectorLines,vectorPolygons]})],target:"map",view:new ol.View({center:ol.proj.fromLonLat([105.7812196468,10.0326663005]),zoom:17}),controls:ol.control.defaults().extend([new ol.control.ScaleLine,new ol.control.FullScreen,mousePositionControl,new ol.control.ZoomToExtent({label:"C",tip:"Trở về CUSC",extent:[105.773484156,10.0352887317]})])});map.getLayers().forEach(function(e,t){bindInputs("#layer"+t,e),e instanceof ol.layer.Group&&e.getLayers().forEach(function(e,o){bindInputs("#layer"+t+o,e)})}),document.getElementById("refresh-points").addEventListener("click",function(){vectorPoints.setStyle(pointStyleFunction)}),document.getElementById("refresh-lines").addEventListener("click",function(){vectorLines.setStyle(lineStyleFunction)}),document.getElementById("refresh-polygons").addEventListener("click",function(){vectorPolygons.setStyle(polygonStyleFunction)}),String.prototype.trunc=String.prototype.trunc||function(e){return this.length>e?this.substr(0,e-1)+"...":this.substr(0)},map.on("pointermove",pointerMoveHandler),map.getViewport().addEventListener("mouseout",function(){helpTooltipElement.classList.add("hidden")});var typeSelect=document.getElementById("type"),geodesicCheckbox=document.getElementById("geodesic"),draw,formatLength=function(e){var t;if(geodesicCheckbox.checked){var o=e.getCoordinates();t=0;for(var n=map.getView().getProjection(),l=0,i=o.length-1;i>l;++l){var r=ol.proj.transform(o[l],n,"EPSG:4326"),s=ol.proj.transform(o[l+1],n,"EPSG:4326");t+=wgs84Sphere.haversineDistance(r,s)}}else t=Math.round(100*e.getLength())/100;var a;return a=t>100?Math.round(t/1e3*100)/100+" km":Math.round(100*t)/100+" m"},formatArea=function(e){var t;if(geodesicCheckbox.checked){var o=map.getView().getProjection(),n=e.clone().transform(o,"EPSG:4326"),l=n.getLinearRing(0).getCoordinates();t=Math.abs(wgs84Sphere.geodesicArea(l))}else t=e.getArea();var i;return i=t>1e4?Math.round(t/1e6*100)/100+" km<sup>2</sup>":Math.round(100*t)/100+" m<sup>2</sup>"};typeSelect.onchange=function(){map.removeInteraction(draw),addInteraction()},addInteraction(),$("#layertree li > span").click(function(){$(this).siblings("fieldset").toggle()}).siblings("fieldset").hide();